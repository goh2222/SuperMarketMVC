<%- include('partials/header', { pageTitle: 'Jeffery Market' }) %>

  <div class="container">
    <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="text-center"><h2>Products from Jeffery Market Database</h2></div>
    <br>
    <!-- Filter form -->
    <div class="row mb-3">
      <div class="col-12 d-flex justify-content-center">
        <form id="inventory-filter-form" class="form-inline" method="GET" action="/inventory">
          <label class="me-2 mt-1">Category:</label>
          <select name="category" class="form-select me-2" style="width:200px; display:inline-block;">
            <option value="All" <%= (typeof selectedCategory === 'undefined' || selectedCategory === 'All') ? 'selected' : '' %>>All</option>
            <% if (typeof categories !== 'undefined') { %>
              <% categories.forEach(function(cat) { %>
                <option value="<%= cat %>" <%= (typeof selectedCategory !== 'undefined' && String(selectedCategory).trim().toLowerCase() === String(cat).trim().toLowerCase()) ? 'selected' : '' %>><%= cat %></option>
              <% }); %>
            <% } %>
          </select>
          <label class="me-2 mt-1">Price:</label>
          <input type="number" name="minPrice" class="form-control me-1" style="width:110px; display:inline-block;" placeholder="Min" step="0.01" min="0" value="<%= typeof minPrice !== 'undefined' ? minPrice : '' %>">
          <span class="me-1 mt-2">-</span>
          <input type="number" name="maxPrice" class="form-control me-2" style="width:110px; display:inline-block;" placeholder="Max" step="0.01" min="0" value="<%= typeof maxPrice !== 'undefined' ? maxPrice : '' %>">
          <button type="button" id="inventory-filter-btn" class="btn btn-outline-primary" onclick="applyInventoryFilter()">Filter</button>
        </form>
      </div>
    </div>
    <div class="row g-4">
      <% for(let i=0; i < products.length; i++) { %>
        <div class="col-12 col-sm-6 col-md-6 col-lg-4">
          <div class="product-card card h-100 position-relative">
            <% if (user && user.role === 'admin' && (products[i].quantity || 0) < 10) { %>
              <span class="badge bg-danger text-white position-absolute d-flex align-items-center" title="Low stock" aria-label="Low stock" style="top:10px; left:10px; z-index:20; min-width:80px; height:36px; border-radius:6px; padding:6px 10px; gap:8px;">
                <!-- inline SVG alert icon (exclamation triangle) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                  <line x1="12" y1="9" x2="12" y2="13"></line>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span style="font-size:0.92rem; font-weight:600; line-height:1;">Low stock</span>
              </span>
            <% } %>
            <div class="card-body d-flex flex-column">
              <div class="text-center mb-3">
                <a href="/product/<%= products[i].id %>"><img class="product-img" src="/images/<%= products[i].image %>" alt="<%= products[i].productName %>"></a>
              </div>
              <h5 class="card-title"><a href="/product/<%= products[i].id %>" class="text-dark"><%= products[i].productName %></a></h5>
              <p class="text-muted small">Available: <strong><%= products[i].quantity %></strong></p>
              <% if (products[i].category) { %>
                <span class="badge bg-secondary mb-2"><%= products[i].category %></span>
              <% } %>
              <% if (products[i].description && String(products[i].description).trim().length) { %>
                <% var descInv = String(products[i].description).trim(); %>
                <p class="mb-2 text-muted small"><%= descInv.length > 80 ? (descInv.substring(0,80) + '...') : descInv %></p>
              <% } %>
              <div class="mt-auto d-flex justify-content-between align-items-center">
                <div>
                  <% const disc = (products[i].discount || 0) * 1; %>
                  <% const discountedPrice = (isFinite(products[i].price) ? Number(products[i].price) : 0) * (1 - (isFinite(disc) ? disc / 100 : 0)); %>
                  <% if (disc && disc > 0) { %>
                    <div><small class="text-muted"><s>$<%= products[i].price.toFixed(2) %></s></small></div>
                    <div><strong>$<%= discountedPrice.toFixed(2) %></strong> <small class="text-success">(<%= disc.toFixed(2) %>% off)</small></div>
                  <% } else { %>
                    <div><strong>$<%= products[i].price.toFixed(2) %></strong></div>
                  <% } %>
                </div>
                <div class="text-end">
                  <a href="/updateProduct/<%= products[i].id %>" class="btn btn-sm btn-outline-primary mb-1">Edit</a>
                  <form action="/deleteProduct/<%= products[i].id %>" method="POST" style="display:inline; margin-left:6px;" onsubmit="return confirm('Delete product?');">
                    <button class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
  <script>
  function applyInventoryFilter() {
    try {
      const form = document.getElementById('inventory-filter-form');
      const params = new URLSearchParams();
      const category = form.querySelector('select[name="category"]').value;
      if (category) params.set('category', category);
      const min = form.querySelector('input[name="minPrice"]').value;
      if (min !== undefined && min !== null && String(min).trim() !== '') params.set('minPrice', min);
      const max = form.querySelector('input[name="maxPrice"]').value;
      if (max !== undefined && max !== null && String(max).trim() !== '') params.set('maxPrice', max);
      const url = '/inventory' + (params.toString() ? ('?' + params.toString()) : '');
      window.location.href = url;
    } catch (e) {
      console.error('Inventory filter apply error', e);
      const f = document.getElementById('inventory-filter-form');
      if (f) f.submit();
    }
  }
</script>
<%- include('partials/footer') %>
